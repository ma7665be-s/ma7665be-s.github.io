<!DOCTYPE html>

<html>
  <head>
    <title>ma7665be-s</title>
    <link rel="stylesheet" href="styles.css">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>

  <body>
    <canvas id="canvas"></canvas>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script src="https://cdn.babylonjs.com/babylon.max.js"></script>
    <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="gameScript.js"></script>
    <script type="application/vertexShader" id="vertexShaderCode">
    precision highp float;

    // Attributes
    attribute vec3 position;
    attribute vec3 normal;
    attribute vec2 uv;
    // Uniforms
    uniform mat4 worldViewProjection;
    uniform mat4 world;
    uniform vec3 lightposition;
    uniform vec3 lightdirection;
    uniform vec3 cameraposition;
    //mat4 projectionView = inverse(projection);
    // Output
    out vec2 tex;
    out vec3 n;
    out vec3 lp;
    out vec3 ld;
    out vec3 cp;
    out vec3 vd;

    void main(void) {
    gl_Position = worldViewProjection * vec4(position, 1.0);
    tex = uv;
    n = normalize((world*vec4(normal,0.0)).xyz);
    vec3 wp = (world*vec4(position,1.0)).xyz;
    ld = normalize(lightposition - wp);
    vd = normalize(cameraposition - wp);

    }
</script>
<script type="application/fragmentShader" id="fragmentShaderCode">
    precision mediump float;

    uniform vec2 invRes;
    uniform sampler2D depthmap;
    uniform sampler2D normalmap;
    uniform mat4 projection;
    uniform mat4 worldView;

    in vec3 n;
    in vec3 ld;
    in vec3 vd;
    in vec2 tex;

    float shininess = 1.0;
    vec3 ambient = vec3(0.1,0.1,0.1);
    vec3 diffuse = vec3(0.0,0.0,0.7);
    vec3 specular = vec3(0.1,0.1,0.1);
    vec3 shadow = vec3(0.0,0.0,0.0);
    float frequency = 200.0;


    vec3 dotify(vec3 dotColor, vec3 backgroundColor, float radius, float freq){
      vec2 rotate45 = mat2(0.707, -0.707, 0.707, 0.707) * tex;
      vec2 nearest = 2.0*fract(frequency * rotate45) - 1.0;
      float dist = length(nearest);
      return mix(dotColor, backgroundColor, step(radius, dist));
    }


    void main(void) {
      //calculate ambient, diffuse and specular lighting
      float normallightangle = dot(ld,n);
      vec3 dif = shadow;
      if(normallightangle < -0.7){
        dif = dotify(shadow,diffuse*0.5,0.7,frequency);
      }else if (normallightangle < 0.0) {
        dif= diffuse*0.5;
      }else{
        dif = dotify(diffuse*0.5,diffuse,0.7,frequency);
      }

      vec3 r = normalize(reflect(ld, n));
      vec3 amb = ambient;
      vec3 spe = specular*pow(step(dot(r,vd), 0.0), shininess);

      //calculate and highlight edges
      vec2 position0 = invRes*gl_FragCoord.xy;
      float scale = 2.0;
      float halfScaleFloor = floor(scale * 0.5);
      float halfScaleCeil = ceil(scale * 0.5);
      vec2 bottomLeft = invRes*vec2(gl_FragCoord.x - halfScaleFloor, gl_FragCoord.y - halfScaleFloor);
      vec2 topRight = invRes*vec2(gl_FragCoord.x + halfScaleCeil, gl_FragCoord.y + halfScaleCeil);
      vec2 bottomRight = invRes*vec2(gl_FragCoord.x + halfScaleCeil, gl_FragCoord.y - halfScaleFloor);
      vec2 topLeft = invRes*vec2(gl_FragCoord.x - halfScaleFloor, gl_FragCoord.y + halfScaleCeil);

      float depth1 = texture(depthmap, bottomLeft).x;texture(depthmap, bottomLeft).x;
      float depth2 = texture(depthmap, topRight).x;
      float depth3 = texture(depthmap, bottomRight).x;
      float depth4 = texture(depthmap, topLeft).x;
      float depthDistance1 = abs(depth1-depth2);
      float depthDistance2 = abs(depth3-depth4);
      float edgeDepth = sqrt(pow(depthDistance1,2.0) + pow(depthDistance2,2.0))
      *100.0;


      vec3 normal1 = texture(normalmap, bottomLeft).xyz;
      vec3 normal2 = texture(normalmap, topRight).xyz;
      vec3 normal3 = texture(normalmap, bottomRight).xyz;
      vec3 normal4 = texture(normalmap, topLeft).xyz;
      vec3 normalDifference1 = normal2 - normal1;
      vec3 normalDifference2 = normal3 - normal4;
      float edgeNormal = sqrt(dot(normalDifference1, normalDifference1) + dot(normalDifference2, normalDifference2));
      vec3 viewPosition = (inverse(projection)*vec4(invRes*gl_FragCoord.xy,0.0,1.0)).xyz;

      vec4 normaltex = texture(normalmap,invRes*gl_FragCoord.xy)*2.0-1.0;
      float NdotV = dot(normalize(normaltex.xyz), -normalize(viewPosition));
      NdotV = 1.0 - (NdotV+1.0)/2.0;
      NdotV = max(NdotV,0.1);

      if(edgeDepth > (0.3*NdotV) || edgeNormal > (4.0*NdotV)){
        dif = vec3(0,0,0);
      }

      gl_FragColor = vec4(amb + dif, 1.0);
    }
</script>
  </body>
</html>
